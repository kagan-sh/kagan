[project]
name = "kagan"
version = "0.5.0-beta.1"
description = "AI-powered Kanban TUI for autonomous development workflows"
license = "MIT"
authors = [
    { name = "Altynbek Orumbayev", email = "altynbek.orumbayev@makerx.com.au" }
]
keywords = ["kanban", "tui", "terminal", "ai", "textual", "project-management", "autonomous"]
classifiers = [
    "Development Status :: 3 - Alpha",
    "Environment :: Console",
    "Intended Audience :: Developers",
    "License :: OSI Approved :: MIT License",
    "Operating System :: OS Independent",
    "Programming Language :: Python :: 3",
    "Programming Language :: Python :: 3.12",
    "Programming Language :: Python :: 3.13",
    "Topic :: Software Development",
    "Topic :: Software Development :: Libraries :: Python Modules",
    "Topic :: Terminals",
    "Topic :: Utilities",
    "Typing :: Typed",
]
requires-python = ">=3.12,<3.14"
readme = "README.md"
dependencies = [
    "agent-client-protocol>=0.7.0,<1.0.0",
    "aiofiles>=24.1.0",
    "aiosqlite>=0.22.0",
    "click>=8.1.0",
    "filelock>=3.16.0",
    "greenlet>=3.1.0",
    "mcp>=1.26.0,<2.0.0",
    "mslex>=1.3.0",
    "packaging>=24.0",
    "platformdirs>=4.3.0",
    "pydantic>=2.10.0",
    "pyperclip>=1.11.0",
    "rich>=14.0.0",
    "sqlmodel>=0.0.22",
    "textual>=7.0.0",
    "tomlkit>=0.13.0",
]

[project.scripts]
kagan = "kagan.__main__:cli"

[project.urls]
Homepage = "https://kagan.sh"
Documentation = "https://docs.kagan.sh"
Repository = "https://github.com/aorumbayev/kagan"
Issues = "https://github.com/aorumbayev/kagan/issues"
Changelog = "https://github.com/aorumbayev/kagan/blob/main/CHANGELOG.md"

[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"

[tool.hatch.build.targets.wheel]
packages = ["src/kagan"]

[dependency-groups]
dev = [
    "poethepoet>=0.40.0",
    "pre-commit>=4.5.1",
    "pytest>=9.0.2",
    "pytest-asyncio>=1.3.0",
    "ruff>=0.14.14",
    "pyrefly>=0.50.0",
    "pytest-textual-snapshot>=1.0.0",
    "mkdocs>=1.6.1",
    "mkdocs-material>=9.5.0",
    "pytest-cov>=7.0.0",
    "pytest-xdist>=3.8.0",
    "python-semantic-release>=10.5.3",
    "hypothesis>=6.100.0",
]

[tool.ruff]
line-length = 100
target-version = "py312"
src = ["src", "tests"]

[tool.ruff.lint]
select = ["E", "F", "I", "UP", "B", "SIM", "TCH", "RUF"]
ignore = [
    "RUF012", # Textual class attributes (BINDINGS, etc.) don't need ClassVar
    "RUF006", # Allow fire-and-forget asyncio.create_task (intentional pattern)
    "SIM102", # Allow nested if statements for readability
    "SIM117", # Allow nested with statements for Textual compose patterns
]

[tool.ruff.lint.per-file-ignores]
"tests/property/*.py" = ["E402"]  # Hypothesis settings must be configured before imports

[tool.ruff.format]
docstring-code-format = true

[tool.pyrefly]
project_includes = ["src", "tests"]
search_path = ["src", "."]
permissive-ignores = true

# Pyrefly does not fully resolve cross-module imports in large projects.
# These are suppressed to avoid false positives. Re-evaluate on pyrefly updates.
[tool.pyrefly.errors]
missing-import = false
missing-attribute = false
missing-module-attribute = false

[tool.pytest.ini_options]
asyncio_mode = "auto"
asyncio_default_fixture_loop_scope = "function"
testpaths = ["tests"]
python_files = ["test_*.py", "*_cases.py"]
markers = [
    "slow: marks tests as slow (deselect with '-m \"not slow\"')",
    "unit: pure logic tests with no I/O",
    "contract: protocol/schema boundary tests",
    "smoke: critical user-path and transport checks",
    "snapshot: visual regression tests",
    "property: property-based tests with hypothesis",
    "core: tests scoped to kagan-core behaviors",
    "mcp: tests scoped to kagan-mcp protocol boundary",
    "tui: tests scoped to textual UI flows and rendering",
    "mock_platform_system(name): override platform.system() for the test",
]
addopts = "-n auto --dist=loadgroup"

[tool.coverage.run]
source = ["src/kagan"]
branch = true
parallel = true
omit = ["*/tests/*", "*/__main__.py"]

[tool.coverage.report]
exclude_lines = [
    "pragma: no cover",
    "if TYPE_CHECKING:",
    "raise NotImplementedError",
]

[tool.poe.tasks]
dev = "textual run --dev src/kagan/app.py"
test = "pytest tests/"
lint = "ruff check src/ tests/"
format = "ruff format src/ tests/"
typecheck = "pyrefly check src/ tests/"
check = ["lint", "typecheck", "test-core", "test-mcp", "test-smoke"]
docs-serve = "mkdocs serve"
docs-build = "mkdocs build"
# Snapshot tests (run sequentially - parallel can cause issues with snapshots)
test-core = "pytest tests/core/unit/ -m \"core and unit\" -v"
test-mcp = "pytest tests/mcp/contract/ -m \"mcp and contract\" -v"
test-tui-snapshot = "pytest tests/tui/snapshot/ -m \"tui and snapshot\" -n 0 -v"
test-smoke-core = "pytest tests/core/smoke/ tests/mcp/smoke/ -m smoke -v"
test-smoke-tui = "pytest tests/tui/smoke/ -m \"tui and smoke\" -n 0 -v"
test-smoke = ["test-smoke-core", "test-smoke-tui"]
test-snapshot = "pytest tests/tui/snapshot/ -n 0 -v"
test-snapshot-update = "pytest tests/tui/snapshot/ -n 0 -v --snapshot-update"

[tool.poe.tasks.install-local]
help = "Install kagan as a local CLI tool (replaces any existing install)"
cmd = "uv tool install --force --reinstall ."

[tool.poe.tasks.dev-setup]
help = "Install local CLI, reset DB, and stop core daemon"
sequence = [
    { ref = "install-local" },
    { cmd = "kagan reset --force" },
    { shell = "kagan core stop || true" },
]

[tool.poe.tasks.fix]
help = "Fix linting issues and format code"
sequence = [
    { cmd = "ruff check --fix src/ tests/" },
    { cmd = "ruff format src/ tests/" },
]

[tool.poe.tasks.release-preview]
sequence = [
  { cmd = "uv run semantic-release version --print-last-released-tag" },
  { cmd = "uv run semantic-release version --print-tag --as-prerelease" },
]
help = "Preview current and next prerelease version"

[tool.poe.tasks.release-dry-run-beta]
shell = "uv run semantic-release --noop -vv version --as-prerelease --prerelease-token beta --print-tag"
help = "Dry-run beta release (no changes made)"

[tool.poe.tasks.workflows-check]
help = "Validate GitHub Actions workflows using act (requires act installed)"
sequence = [
    { shell = "act --list -W .github/workflows/" },
    { shell = "act push --dryrun -W .github/workflows/ci.yml" },
    { shell = "act workflow_dispatch --dryrun -W .github/workflows/cd.yaml" },
    { shell = "act workflow_dispatch --dryrun -W .github/workflows/post-release-update-test.yaml" },
]

[tool.semantic_release]
version_toml = ["pyproject.toml:project.version"]
build_command = "pip install uv && uv build --wheel"
commit_message = "{version}\n\n[skip ci] Automatically generated by python-semantic-release"
tag_format = "v{version}"
allow_zero_version = true

[tool.semantic_release.branches.main]
match = "main"
prerelease_token = "beta"
prerelease = false

[tool.semantic_release.commit_parser_options]
allowed_tags = [
    "build",
    "chore",
    "ci",
    "docs",
    "feat",
    "fix",
    "perf",
    "style",
    "refactor",
    "test",
]
minor_tags = ["feat"]
patch_tags = ["fix", "perf", "docs"]

[tool.semantic_release.publish]
dist_glob_patterns = ["dist/*"]
upload_to_vcs_release = true

[tool.semantic_release.remote.token]
env = "GITHUB_TOKEN"
