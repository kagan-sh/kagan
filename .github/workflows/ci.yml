name: CI

on:
  pull_request:
    paths-ignore:
      - "docs/**"
      - "*.md"
      - ".github/assets/**"
      - "mkdocs.yml"
      - ".readthedocs.yaml"
  push:
    branches: [main]
    paths-ignore:
      - "docs/**"
      - "*.md"
      - ".github/assets/**"
      - "mkdocs.yml"
      - ".readthedocs.yaml"

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
      - run: uv sync --dev
      - run: uv run poe lint
      - run: uv run poe typecheck

  test:
    needs: lint
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v6
      - name: Install system dependencies
        if: runner.os != 'Windows'
        run: |
          if [ "$RUNNER_OS" = "Linux" ]; then
            sudo apt-get update
            sudo apt-get install -y tmux git
          elif [ "$RUNNER_OS" = "macOS" ]; then
            brew install tmux
          fi
      - name: Install system dependencies (Windows)
        if: runner.os == 'Windows'
        run: choco install git -y
      - name: Configure git for tests
        run: |
          git config --global user.email "test@kagan.local"
          git config --global user.name "Kagan Test"
          git config --global commit.gpgsign false
      - uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
      - run: uv sync --dev
      - name: Test (with coverage)
        if: github.ref == 'refs/heads/main'
        run: uv run pytest tests/ -m "not snapshot" -n auto --cov=src/kagan --cov-report=term-missing
      - name: Test
        if: github.ref != 'refs/heads/main'
        run: uv run pytest tests/ -m "not snapshot" -n auto

  snapshot:
    needs: lint
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y tmux git
      - name: Configure git for tests
        run: |
          git config --global user.email "test@kagan.local"
          git config --global user.name "Kagan Test"
          git config --global commit.gpgsign false
      - uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
      - run: uv sync --dev
      - name: Snapshot tests (sequential)
        run: uv run pytest tests/snapshots/ -n 0 -v

  test-all-platforms:
    needs: lint
    if: github.ref == 'refs/heads/main'
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-24.04-arm, macos-15-intel]
    steps:
      - uses: actions/checkout@v6
      - name: Install system dependencies
        run: |
          if [ "$RUNNER_OS" = "Linux" ]; then
            sudo apt-get update
            sudo apt-get install -y tmux git
          elif [ "$RUNNER_OS" = "macOS" ]; then
            brew install tmux
          fi
      - name: Configure git for tests
        run: |
          git config --global user.email "test@kagan.local"
          git config --global user.name "Kagan Test"
          git config --global commit.gpgsign false
      - uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
      - run: uv sync --dev
      # Exclude snapshot tests from matrix runs; covered by dedicated job.
      - run: uv run pytest tests/ -m "not snapshot" -n auto --cov=src/kagan --cov-report=term-missing
